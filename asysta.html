<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSK Ultrasound Simulator - Edukacyjny</title>
    <style>
        :root {
            --color-primary: #2180a5;
            --color-primary-hover: #1a6580;
            --color-primary-active: #1a4760;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c7d;
            --color-success: #2180a5;
            --color-warning: #a84b2f;
            --color-error: #c0152f;
            --color-border: rgba(94, 82, 64, 0.2);
            --focus-ring: 0 0 0 3px rgba(33, 128, 141, 0.4);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .image-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            flex: 1;
        }

        .canvas-container {
            background: #000;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            max-height: 500px;
        }

        .image-info {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .controls-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text);
        }

        .control-group {
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--color-border);
        }

        .control-group:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .control-value {
            font-size: 12px;
            color: var(--color-primary);
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--color-secondary);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 150ms ease;
        }

        .slider::-webkit-slider-thumb:hover {
            background: var(--color-primary-hover);
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 150ms ease;
        }

        .slider::-moz-range-thumb:hover {
            background: var(--color-primary-hover);
            transform: scale(1.2);
        }

        .slider:focus-visible {
            box-shadow: var(--focus-ring);
        }

        .tgc-sliders {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 80px;
            margin-top: 8px;
            padding: 8px 4px;
            background: rgba(94, 82, 64, 0.05);
            border-radius: 4px;
        }

        .tgc-slider {
            flex: 1;
            height: 100%;
            border-radius: 2px;
            background: var(--color-secondary);
            outline: none;
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
            cursor: pointer;
        }

        .tgc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .assistant-panel {
            background: linear-gradient(135deg, rgba(33, 128, 141, 0.08) 0%, rgba(41, 150, 161, 0.08) 100%);
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            padding: 14px;
        }

        .assistant-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 12px;
            color: var(--color-primary);
        }

        .assistant-icon {
            font-size: 16px;
        }

        .assistant-message {
            font-size: 12px;
            line-height: 1.6;
            color: var(--color-text);
        }

        .message-tip {
            background: rgba(33, 128, 141, 0.1);
            padding: 8px;
            border-left: 3px solid var(--color-primary);
            border-radius: 3px;
            margin-top: 8px;
            font-size: 10px;
            line-height: 1.5;
        }

        .stats-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 14px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: var(--color-text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--color-text);
        }

        .quality-indicator {
            display: flex;
            gap: 4px;
            margin-top: 10px;
        }

        .quality-bar {
            flex: 1;
            height: 6px;
            background: var(--color-secondary);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .quality-bar.good {
            background: rgba(33, 128, 141, 0.2);
        }

        .quality-bar.warning {
            background: rgba(168, 75, 47, 0.2);
        }

        .quality-bar.bad {
            background: rgba(192, 21, 47, 0.2);
        }

        .quality-fill {
            height: 100%;
            background: var(--color-success);
            border-radius: 3px;
            transition: width 300ms ease;
        }

        .quality-bar.warning .quality-fill {
            background: var(--color-warning);
        }

        .quality-bar.bad .quality-fill {
            background: var(--color-error);
        }

        button {
            background: var(--color-primary);
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background: var(--color-primary-hover);
        }

        button:active {
            background: var(--color-primary-active);
        }

        button:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .info-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-text {
            font-size: 12px;
            line-height: 1.6;
            color: var(--color-text-secondary);
        }

        .key-relations {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            font-size: 11px;
        }

        .relation-box {
            background: rgba(94, 82, 64, 0.05);
            padding: 8px;
            border-radius: 4px;
            border-left: 2px solid var(--color-primary);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .right-column {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .key-relations {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ MSK Ultrasound Simulator</h1>
            <p class="subtitle">Interaktywny edukacyjny symulator ultrasonografii muskuloszkieletowej</p>
        </header>

        <div class="main-layout">
            <div class="left-column">
                <div class="image-section">
                    <h2 style="margin: 0 0 15px 0; font-size: 16px;">Obraz ultrasonograficzny</h2>
                    <div class="canvas-container">
                        <canvas id="ultrasoundCanvas" width="800" height="480"></canvas>
                    </div>
                    <div class="image-info" id="imageInfo">Zmie≈Ñ parametry aby zobaczyƒá zmianƒô obrazu</div>
                </div>

                <div class="info-section">
                    <div class="info-title">üìö Zasady fizyki ultrasonografii</div>
                    <div class="info-text">
                        <strong>Focal Zone (Strefa ogniskowania):</strong> Najwƒô≈∫sze miejsce wiƒÖzki ultrad≈∫wiƒôk√≥w, gdzie rozdzielczo≈õƒá jest najlepsza. Kiedy przesuwasz focus, zmienia siƒô g≈Çƒôboko≈õƒá tej strefy.<br><br>
                        <strong>Frequency (Czƒôstotliwo≈õƒá):</strong> Wy≈ºsza = lepsza rozdzielczo≈õƒá ale s≈Çabsza penetracja. Ni≈ºsza = lepsza penetracja ale gorsza rozdzielczo≈õƒá.<br><br>
                        <strong>Gain:</strong> Wzmocnienie sygna≈Çu - sprawia ≈ºe obraz jest ja≈õniejszy. Zbyt wysoki gain dodaje szum.<br><br>
                        <strong>TGC (Time Gain Compensation):</strong> Kompensuje os≈Çabienie sygna≈Çu na g≈Çƒôboko≈õci - to 8 suwak√≥w regulujƒÖcych jasno≈õƒá w r√≥≈ºnych g≈Çƒôbo≈õciach.
                    </div>
                    <div class="key-relations">
                        <div class="relation-box">
                            <strong>Focus p≈Çytko ‚Üë</strong><br>‚Üí Lepszy obraz g√≥ry<br>‚Üí Podnie≈õƒá czƒôstotliwo≈õƒá
                        </div>
                        <div class="relation-box">
                            <strong>Focus g≈Çƒôbokie ‚Üì</strong><br>‚Üí Lepszy obraz do≈Çu<br>‚Üí Obni≈ºyƒá czƒôstotliwo≈õƒá
                        </div>
                        <div class="relation-box">
                            <strong>Frame Rate ‚Üë</strong><br>‚Üí Zmniejszyƒá depth<br>‚Üí Zmniejszyƒá DR
                        </div>
                        <div class="relation-box">
                            <strong>Resolution ‚Üë</strong><br>‚Üí Zwiƒôkszyƒá frequency<br>‚Üí Zbli≈ºyƒá focus
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="controls-panel">
                    <div class="panel-title">‚öôÔ∏è Podstawowe kontrole</div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>Focus Depth</span>
                            <span class="control-value" id="focusValue">3.0 cm</span>
                        </div>
                        <input type="range" id="focusSlider" class="slider" min="0.5" max="6" step="0.1" value="3">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">G≈Çƒôboko≈õƒá ogniskowania (cm)</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Gain</span>
                            <span class="control-value" id="gainValue">50%</span>
                        </div>
                        <input type="range" id="gainSlider" class="slider" min="10" max="100" step="5" value="50">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Wzmocnienie ca≈Çkowite</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Frequency</span>
                            <span class="control-value" id="freqValue">12 MHz</span>
                        </div>
                        <input type="range" id="frequencySlider" class="slider" min="5" max="18" step="1" value="12">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Czƒôstotliwo≈õƒá wiƒÖzki</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Depth</span>
                            <span class="control-value" id="depthValue">5 cm</span>
                        </div>
                        <input type="range" id="depthSlider" class="slider" min="2" max="10" step="0.5" value="5">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">G≈Çƒôboko≈õƒá penetracji</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Dynamic Range (DR)</span>
                            <span class="control-value" id="drValue">60 dB</span>
                        </div>
                        <input type="range" id="drSlider" class="slider" min="30" max="80" step="5" value="60">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Zakres dynamiki obrazu</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Frame Rate</span>
                            <span class="control-value" id="frValue">50 fps</span>
                        </div>
                        <input type="range" id="frSlider" class="slider" min="20" max="100" step="10" value="50">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Szybko≈õƒá od≈õwie≈ºania</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>CF Box (Color Flow)</span>
                            <span class="control-value" id="cfValue">Medium</span>
                        </div>
                        <select id="cfSelect" style="width: 100%; padding: 6px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 12px;">
                            <option value="0">Off</option>
                            <option value="1">Small</option>
                            <option value="2" selected>Medium</option>
                            <option value="3">Large</option>
                        </select>
                    </div>
                </div>

                <div class="controls-panel">
                    <div class="panel-title">üéöÔ∏è TGC Sliders (8 poziom√≥w)</div>
                    <div class="tgc-sliders" id="tgcContainer"></div>
                    <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 8px; text-align: center;">Kompensacja czasu wzmocnienia</div>
                </div>

                <div class="stats-panel">
                    <div class="panel-title">üìä Jako≈õƒá obrazu</div>
                    <div class="stat-item">
                        <span class="stat-label">Rozdzielczo≈õƒá osiowa:</span>
                        <span class="stat-value" id="axialRes">0.35 mm</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Rozdzielczo≈õƒá boczna:</span>
                        <span class="stat-value" id="lateralRes">0.5 mm</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Penetracja:</span>
                        <span class="stat-value" id="penetration">≈örednia</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SNR:</span>
                        <span class="stat-value" id="snr">20 dB</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="font-size: 11px; margin-bottom: 5px; font-weight: 500;">Og√≥lna jako≈õƒá:</div>
                        <div class="quality-indicator">
                            <div class="quality-bar good">
                                <div class="quality-fill" id="qualityBar" style="width: 75%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="assistant-panel">
                    <div class="assistant-header">
                        <span class="assistant-icon">ü§ñ</span>
                        <span>Asystent AI - Analiza G≈Çƒôboka</span>
                    </div>
                    <div class="assistant-message" id="assistantMessage" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 11px;">
                        Witaj! Jestem Twoim wirtualnym asystentem. Zmieniaj parametry a ja bƒôdƒô Ci podpowiada≈Ç jak je optymalizowaƒá dla ka≈ºdego aspektu obrazu.
                    </div>
                    <div class="message-tip" id="messageTip" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-size: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('ultrasoundCanvas');
        const ctx = canvas.getContext('2d');

        // Elementy kontrolne
        const focusSlider = document.getElementById('focusSlider');
        const gainSlider = document.getElementById('gainSlider');
        const frequencySlider = document.getElementById('frequencySlider');
        const depthSlider = document.getElementById('depthSlider');
        const drSlider = document.getElementById('drSlider');
        const frSlider = document.getElementById('frSlider');
        const cfSelect = document.getElementById('cfSelect');

        // Wy≈õwietlacze warto≈õci
        const displays = {
            focus: document.getElementById('focusValue'),
            gain: document.getElementById('gainValue'),
            freq: document.getElementById('freqValue'),
            depth: document.getElementById('depthValue'),
            dr: document.getElementById('drValue'),
            fr: document.getElementById('frValue'),
            cf: document.getElementById('cfValue')
        };

        // Parametry
        let params = {
            focus: 3.0,
            gain: 50,
            frequency: 12,
            depth: 5,
            dr: 60,
            fr: 50,
            cfBox: 2
        };

        // TGC sliders
        let tgcValues = [40, 45, 50, 55, 60, 65, 70, 75];

        // Inicjalizacja TGC slider√≥w
        const tgcContainer = document.getElementById('tgcContainer');
        tgcValues.forEach((val, idx) => {
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.class = 'tgc-slider';
            slider.min = '0';
            slider.max = '100';
            slider.value = val;
            slider.style.flex = '1';
            slider.style.height = '100%';
            slider.style.borderRadius = '2px';
            slider.style.background = 'var(--color-secondary)';
            slider.style.outline = 'none';
            slider.style.cursor = 'pointer';
            slider.addEventListener('input', (e) => {
                tgcValues[idx] = parseInt(e.target.value);
                updateImage();
                updateAssistant();
            });
            tgcContainer.appendChild(slider);
        });

        // Event listeners
        focusSlider.addEventListener('input', (e) => {
            params.focus = parseFloat(e.target.value);
            displays.focus.textContent = params.focus.toFixed(1) + ' cm';
            updateImage();
            updateAssistant();
        });

        gainSlider.addEventListener('input', (e) => {
            params.gain = parseInt(e.target.value);
            displays.gain.textContent = params.gain + '%';
            updateImage();
            updateAssistant();
        });

        frequencySlider.addEventListener('input', (e) => {
            params.frequency = parseInt(e.target.value);
            displays.freq.textContent = params.frequency + ' MHz';
            updateImage();
            updateAssistant();
        });

        depthSlider.addEventListener('input', (e) => {
            params.depth = parseFloat(e.target.value);
            displays.depth.textContent = params.depth.toFixed(1) + ' cm';
            updateImage();
            updateAssistant();
        });

        drSlider.addEventListener('input', (e) => {
            params.dr = parseInt(e.target.value);
            displays.dr.textContent = params.dr + ' dB';
            updateImage();
            updateAssistant();
        });

        frSlider.addEventListener('input', (e) => {
            params.fr = parseInt(e.target.value);
            displays.fr.textContent = params.fr + ' fps';
            updateImage();
            updateAssistant();
        });

        cfSelect.addEventListener('change', (e) => {
            params.cfBox = parseInt(e.target.value);
            const cfLabels = ['Off', 'Small', 'Medium', 'Large'];
            displays.cf.textContent = cfLabels[params.cfBox];
            updateImage();
            updateAssistant();
        });

        // Funkcja rysujƒÖca obraz USG
        function updateImage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // T≈Ço
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a1a');
            gradient.addColorStop(1, '#0a0a0a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Rysuj warstwowe tkanki z szumem (speckle)
            const pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = pixelData.data;

            for (let i = 0; i < data.length; i += 4) {
                const pixelIndex = i / 4;
                const x = pixelIndex % canvas.width;
                const y = Math.floor(pixelIndex / canvas.width);

                // Normalizuj wsp√≥≈Çrzƒôdne
                const normY = y / canvas.height;
                const depthCm = normY * params.depth;

                // Generuj szum (speckle) - symulacja tkanki
                let noise = Math.sin(x * 0.01) * Math.cos(y * 0.01) * 30 + 
                           Math.random() * 40 - 20;

                // Struktura warstwowa
                let intensity = 30;

                // Warstwa 1: Sk√≥ra i podsk√≥rna (0-1cm)
                if (depthCm < 1.0) {
                    intensity = 40 + Math.sin(x * 0.05) * 15;
                }
                // Warstwa 2: Powiƒô≈∫ (1-2cm)
                else if (depthCm < 2.0) {
                    intensity = 50 + Math.cos(x * 0.03) * 20;
                }
                // Warstwa 3: Miƒôsie≈Ñ (2-4cm)
                else if (depthCm < 4.0) {
                    intensity = 70 + Math.sin((x + y) * 0.02) * 25;
                }
                // Warstwa 4: G≈Çƒôbokie tkanki (4+cm)
                else {
                    intensity = 50 + Math.sin(x * 0.01) * 15;
                }

                // Focal zone - zwiƒôksz jasno≈õƒá w obszarze focus
                const focusCenter = (params.focus / params.depth) * canvas.height;
                const distFromFocus = Math.abs(y - focusCenter);
                const focalWidth = 20 * (1 - Math.abs(params.frequency - 12) / 6);
                
                if (distFromFocus < focalWidth) {
                    const focalBoost = (1 - distFromFocus / focalWidth) * 40;
                    intensity += focalBoost;
                }

                // Attenuation z g≈Çƒôbo≈õciƒÖ
                const attenuationFactor = Math.exp(-depthCm * params.frequency / 30);
                intensity *= attenuationFactor;

                // Aplikuj gain
                intensity = intensity * (params.gain / 50);

                // TGC kompensacja
                const tgcIndex = Math.floor(normY * 7);
                const tgcGain = tgcValues[tgcIndex] / 50;
                intensity *= tgcGain;

                // DR (Dynamic Range) - kontrola kontrastu
                if (intensity < params.dr - 60) {
                    intensity = 0;
                }

                // Frequency wp≈Çywa na rozdzielczo≈õƒá i szum
                const freqNoise = params.frequency > 12 ? Math.random() * 20 : Math.random() * 10;
                intensity += freqNoise;

                // Clamp do 0-255
                intensity = Math.max(0, Math.min(255, intensity));

                // Ustaw RGBA
                data[i] = intensity;      // R
                data[i + 1] = intensity;  // G
                data[i + 2] = intensity;  // B
                data[i + 3] = 255;        // A
            }

            ctx.putImageData(pixelData, 0, 0);

            // Rysuj fokus marker
            const focusY = (params.focus / params.depth) * canvas.height;
            ctx.strokeStyle = 'rgba(33, 200, 150, 0.7)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, focusY);
            ctx.lineTo(canvas.width, focusY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Rysuj CF Box je≈õli w≈ÇƒÖczony
            if (params.cfBox > 0) {
                drawCFBox();
            }

            // Rysuj skalƒô g≈Çƒôboko≈õci
            drawDepthScale();

            updateStats();
        }

        function drawCFBox() {
            const boxSizes = [0, 0.25, 0.4, 0.6];
            const boxHeightPercent = boxSizes[params.cfBox];
            
            if (boxHeightPercent === 0) return;

            const focusY = (params.focus / params.depth) * canvas.height;
            const boxHeight = canvas.height * boxHeightPercent;
            const boxTop = focusY - boxHeight / 2;
            const boxWidth = canvas.width * 0.3;
            const boxLeft = (canvas.width - boxWidth) / 2;

            // ProstokƒÖtna obw√≥dka CF box
            ctx.strokeStyle = 'rgba(50, 200, 200, 0.8)';
            ctx.lineWidth = 2;
            ctx.strokeRect(boxLeft, Math.max(0, boxTop), boxWidth, Math.min(canvas.height, boxHeight));

            // Strza≈Çka pokazujƒÖca kierunek Dopplera
            ctx.fillStyle = 'rgba(50, 200, 200, 0.6)';
            ctx.font = '12px Arial';
            ctx.fillText('CF Box', boxLeft + 5, Math.max(15, boxTop + 15));
        }

        function drawDepthScale() {
            ctx.fillStyle = 'rgba(200, 200, 200, 0.7)';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';

            const step = params.depth > 5 ? 1 : 0.5;
            for (let depth = 0; depth <= params.depth; depth += step) {
                const y = (depth / params.depth) * canvas.height;
                ctx.fillText(depth.toFixed(1) + ' cm', canvas.width - 5, y + 3);
            }
        }

        function updateStats() {
            // Rozdzielczo≈õƒá osiowa (axial) - zale≈ºy od d≈Çugo≈õci impulsu i czƒôstotliwo≈õci
            const pulseLength = 1 / params.frequency;
            const axialRes = (pulseLength * 0.5).toFixed(2);
            document.getElementById('axialRes').textContent = axialRes + ' mm';

            // Rozdzielczo≈õƒá boczna (lateral) - zale≈ºy od fokusa i czƒôstotliwo≈õci
            const focalZoneWidth = 0.3 + (12 - params.frequency) * 0.05;
            const lateralRes = (focalZoneWidth * 0.8).toFixed(2);
            document.getElementById('lateralRes').textContent = lateralRes + ' mm';

            // Penetracja
            const attenuation = Math.exp(-params.depth * params.frequency / 30);
            let penetrationText = 'S≈Çaba';
            if (attenuation > 0.5) penetrationText = '≈örednia';
            if (attenuation > 0.7) penetrationText = 'Dobra';
            document.getElementById('penetration').textContent = penetrationText;

            // SNR (Signal-to-Noise Ratio)
            const snr = 20 - params.frequency + params.gain / 2.5 - params.depth * 2;
            document.getElementById('snr').textContent = snr.toFixed(0) + ' dB';

            // Og√≥lna jako≈õƒá
            const axialScore = (1 - Math.abs(params.frequency - 12) / 6) * 25;
            const gainScore = (params.gain > 30 && params.gain < 70) ? 25 : 15;
            const focusScore = (params.focus > 1 && params.focus < 5) ? 25 : 15;
            const tgcScore = calculateTGCQuality();
            const totalQuality = axialScore + gainScore + focusScore + tgcScore;

            const qualityBar = document.getElementById('qualityBar');
            const qualityPercent = (totalQuality / 100) * 100;
            qualityBar.style.width = qualityPercent + '%';

            const qualityBarDiv = qualityBar.closest('.quality-bar');
            qualityBarDiv.className = 'quality-bar';
            if (qualityPercent > 70) {
                qualityBarDiv.classList.add('good');
            } else if (qualityPercent > 40) {
                qualityBarDiv.classList.add('warning');
            } else {
                qualityBarDiv.classList.add('bad');
            }
        }

        function calculateTGCQuality() {
            // Sprawd≈∫ czy TGC jest rozsƒÖdnie ustawiony (powinna byƒá krzywa rosnƒÖca)
            let score = 25;
            let prevVal = tgcValues[0];
            let isMonotonic = true;

            for (let i = 1; i < tgcValues.length; i++) {
                if (tgcValues[i] < prevVal - 10) {
                    isMonotonic = false;
                }
                prevVal = tgcValues[i];
            }

            return isMonotonic ? 25 : 10;
        }

        function updateAssistant() {
            const advice = generateAdvice();
            const messageDiv = document.getElementById('assistantMessage');
            const tipDiv = document.getElementById('messageTip');
            
            messageDiv.textContent = advice.message;
            tipDiv.textContent = advice.tip;

            // Wy≈õwietl score na koniec
            const scorePercent = Math.round((advice.score / advice.maxScore) * 100);
            tipDiv.innerHTML += `<br><br><strong>Og√≥lny score konfiguracji: ${scorePercent}%</strong>`;
        }

        function generateAdvice() {
            let messages = [];
            let tips = [];
            let score = { focus: 0, frequency: 0, gain: 0, tgc: 0, dr: 0, fr: 0, cf: 0 };

            // ===== 1. ANALIZA FOCUS =====
            if (params.focus < 0.8) {
                messages.push('üìç Focus BARDZO P≈ÅYTKO (<0.8cm) - tylko sk√≥ra i podsk√≥rna');
                if (params.frequency < 12) {
                    tips.push('üîß P≈ÅYTKO + NISKA FREQ: Zwiƒôksz do 15-18 MHz dla super rozdzielczo≈õci sk√≥ry.');
                } else if (params.frequency > 15) {
                    tips.push('‚úÖ Doskona≈Ça kombinacja dla badania sk√≥ry i struktur powierzchniowych.');
                    score.focus = 25;
                } else {
                    tips.push('üí° Baƒá siƒô mo≈ºemy attenuation na krawƒôdzi wiƒÖzki, rozwa≈º zwiƒôkszenie gain-u.');
                }
            } else if (params.focus < 1.5) {
                messages.push('üìç Focus P≈ÅYTKO (0.8-1.5cm) - powiƒô≈∫ i g√≥rne miƒô≈õnie');
                if (params.frequency < 10) {
                    messages.push('‚ö†Ô∏è P≈ÅYTKO + NISKA FREQ = nieoptymalne! Zwiƒôksz do 12-15 MHz.');
                    tips.push('üéØ Przy p≈Çytkim focus powinna byƒá WY≈ªSZA czƒôstotliwo≈õƒá dla lepszej rozdzielczo≈õci.');
                } else if (params.frequency >= 12 && params.frequency <= 15) {
                    messages.push('‚úÖ Optymalna kombinacja dla badania powierzchniowych struktur MSK.');
                    score.focus = 25;
                    score.frequency = 20;
                    tips.push('üî¨ Focal zone jest tutaj najbli≈ºej - obserwuj zmianƒô kontrastu.');
                }
            } else if (params.focus >= 1.5 && params.focus <= 3.0) {
                messages.push('üìç Focus ≈öREDNI (1.5-3cm) - miƒô≈õnie, ≈õciƒôgna, nerwy');
                if (params.frequency >= 10 && params.frequency <= 14) {
                    messages.push('‚úÖ IDEALNA konfiguracja dla typowego badania MSK!');
                    score.focus = 30;
                    score.frequency = 25;
                    tips.push('üèÜ To jest obszar pracy wiƒôkszo≈õci lekarzy - struktury MSK sƒÖ tutaj najbardziej widoczne.');
                    tips.push('üí° Focal zone zapewnia najlepszƒÖ rozdzielczo≈õƒá osiowƒÖ w tym obszarze.');
                } else if (params.frequency > 14) {
                    tips.push('‚ö†Ô∏è Frequency zbyt wysoka dla tej g≈Çƒôboko≈õci - straƒá bƒôdziesz penetracji. Spr√≥buj 11-13 MHz.');
                } else {
                    tips.push('‚ö†Ô∏è Frequency zbyt niska - rozdzielczo≈õƒá bƒôdzie s≈Çaba. Zwiƒôksz do 10-12 MHz.');
                }
            } else if (params.focus > 3.0 && params.focus <= 4.5) {
                messages.push('üìç Focus G≈ÅƒòBOKI (3-4.5cm) - g≈Çƒôbokie miƒô≈õnie, ko≈õci');
                if (params.frequency <= 10) {
                    messages.push('‚úÖ Dobra kombinacja dla struktur g≈Çƒôbokich.');
                    score.focus = 20;
                    score.frequency = 18;
                    tips.push('üîä Attenuation jest znaczna - sprawdzaj ≈ºe gain jest wystarczajƒÖcy (60-80%).');
                    tips.push('üìä TGC musi rosnƒÖƒá monotonicznie w tym scenariuszu - wa≈º na 6,7,8 poziomach.');
                } else if (params.frequency >= 11 && params.frequency <= 13) {
                    tips.push('üí° Mo≈ºna podnie≈õƒá frequency do 14 MHz je≈õli potrzebujesz lepszej rozdzielczo≈õci.');
                } else {
                    tips.push('‚ö†Ô∏è Frequency zbyt wysoka na tej g≈Çƒôboko≈õci - zmniejsz do 10-12 MHz.');
                }
            } else if (params.focus > 4.5) {
                messages.push('üìç Focus BARDZO G≈ÅƒòBOKI (>4.5cm) - struktury a≈º 5-6cm pod sk√≥rƒÖ');
                if (params.frequency > 12) {
                    messages.push('‚ö†Ô∏è G≈ÅƒòBOKIE + WYSOKA FREQ = problem! Czƒôstotliwo≈õƒá bƒôdzie ca≈Çkowicie t≈Çumiona.');
                    tips.push('‚ùå Zmniejsz do 8-10 MHz - to jedyny spos√≥b aby siƒôgnƒÖƒá tak g≈Çƒôbokie.');
                } else if (params.frequency <= 9) {
                    messages.push('‚úÖ Prawid≈Çowa niska czƒôstotliwo≈õƒá dla bardzo g≈Çƒôbokich struktur.');
                    score.focus = 15;
                    score.frequency = 15;
                    tips.push('‚ö†Ô∏è Rozdzielczo≈õƒá bƒôdzie s≈Çaba, ale to kosztem penetracji. Niech siƒô dzieje.');
                } else {
                    tips.push('üí° Frequency w porzƒÖdku, ale gain musi byƒá 70-90% aby przej≈õƒá a≈º tam.');
                }
            }

            // ===== 2. ANALIZA FREQUENCY =====
            const expectedFreqForDepth = 18 - (params.depth * 1.8);
            const freqDeviation = Math.abs(params.frequency - expectedFreqForDepth);

            if (params.frequency < 7) {
                messages.push('üîâ Frequency ZBYT NISKA (<7 MHz) - ultrasound jest niemal nieu≈ºyteczny');
                tips.push('‚ùå Tylko do bardzo g≈Çƒôbokich struktur (>5cm). Poza tym praktycznie nic nie zobaczysz.');
                score.frequency = 3;
            } else if (params.frequency >= 7 && params.frequency < 10) {
                if (params.depth >= 5) {
                    messages.push('üîâ Frequency niska (7-10 MHz) - ≈õwiadomie dla penetracji');
                    tips.push('‚úÖ To jest kompromis: penetracja > rozdzielczo≈õƒá. OK dla g≈Çƒôbokich struktur.');
                    score.frequency = 15;
                } else {
                    messages.push('üîâ Frequency niska (7-10 MHz) - ale focus jest p≈Çytko?');
                    tips.push('‚ö†Ô∏è Marmujesz potencja≈Ç rozdzielczo≈õci. Podnie≈õ frequency do 12-15 MHz.');
                    score.frequency = 8;
                }
            } else if (params.frequency >= 10 && params.frequency <= 14) {
                if (freqDeviation < 2) {
                    messages.push('‚úÖ Frequency OPTYMALNA (10-14 MHz) - uniwersalna dla MSK');
                    score.frequency = 28;
                    tips.push('üèÜ To jest sweet spot - balans rozdzielczo≈õci i penetracji.');
                    tips.push('üí° Wiƒôkszo≈õƒá sond liniowych pracuje w tym range.');
                } else if (params.frequency > expectedFreqForDepth) {
                    tips.push(`üí° Dla tej g≈Çƒôboko≈õci (${params.depth.toFixed(1)}cm), ${expectedFreqForDepth.toFixed(0)} MHz by≈Çaby bardziej optymalna.`);
                }
            } else if (params.frequency >= 15 && params.frequency <= 18) {
                if (params.depth <= 2.5) {
                    messages.push('üîä Frequency wysoka (15-18 MHz) - super dla struktur bardzo p≈Çytkich');
                    tips.push('‚úÖ Rozdzielczo≈õƒá jest na maksimum. Ale straƒá penetracji poni≈ºej 1.5cm.');
                    score.frequency = 22;
                } else {
                    messages.push('üîä Frequency zbyt wysoka - attenuation bƒôdzie gigantyczny!');
                    tips.push('‚ùå Zmniejsz do 11-13 MHz je≈õli badasz co≈õ g≈Çƒôbszego ni≈º 2cm.');
                    score.frequency = 5;
                }
            }

            // ===== 3. ANALIZA GAIN =====
            const focusAttenuation = Math.exp(-params.focus * params.frequency / 30);
            const recommendedGain = 50 / focusAttenuation;

            if (params.gain < 20) {
                messages.push('üîä Gain ZBYT NISKI (<20%) - obraz bƒôdzie czarny i pe≈Çen artefakt√≥w');
                tips.push('‚ùå Zwiƒôksz gain do minimum 40% - ryzykujesz ≈ºe nic nie zobaczysz.');
                score.gain = 2;
            } else if (params.gain >= 20 && params.gain < 35) {
                messages.push('üîä Gain niski (20-35%) - mo≈ºliwe ≈ºe tracisz detale');
                if (params.focus > 3) {
                    tips.push('‚ö†Ô∏è Dla takiego fokusa, gain powinien byƒá wy≈ºszy (55-70%).');
                } else {
                    tips.push('üí° Dla p≈Çytkich struktur ok, ale sprawdzaj czy widaƒá wszystkie detale.');
                }
                score.gain = 12;
            } else if (params.gain >= 35 && params.gain < 45) {
                messages.push('üîä Gain niedostateczny (35-45%)');
                if (params.depth > 5 || params.frequency < 10) {
                    tips.push('‚ö†Ô∏è Dla g≈Çƒôbokich struktur lub niskiej freq, podnie≈õ do 55-70%.');
                }
                score.gain = 18;
            } else if (params.gain >= 45 && params.gain <= 70) {
                messages.push('‚úÖ Gain OPTYMALNY (45-70%)');
                score.gain = 30;
                if (params.gain <= 55) {
                    tips.push('üí° W dolnym range (45-55%): lepiej, gdy masz dobrƒÖ penetracjƒô i TGC.');
                } else {
                    tips.push('üí° W g√≥rnym range (60-70%): bardziej agresywny, gdy potrzebujesz kontrastu.');
                }
            } else if (params.gain > 70 && params.gain <= 85) {
                messages.push('‚ö†Ô∏è Gain zbyt wysoki (70-85%) - widoczne bƒôdƒÖ artefakty i szum');
                tips.push('üîä Zamiast dalej podnosziƒá gain, zwiƒôksz TGC na g≈Çƒôbokim ko≈Ñcu (poziomy 6,7,8).');
                tips.push('üìä Regu≈Ça: 1% gain = oko≈Ço 0.5 dB SNR, TGC te≈º mo≈ºe to zrobiƒá bez artefakt√≥w.');
                score.gain = 15;
            } else if (params.gain > 85) {
                messages.push('‚ùå Gain EKSTREMNIE WYSOKI (>85%) - obraz bƒôdzie szumem');
                tips.push('‚ùå To jest najczƒôstszy b≈ÇƒÖd: zamiast optymalizowaƒá, zwiƒôkszajƒÖ tylko gain.');
                tips.push('üí° Czasami mniej gain + dobra TGC = lepszy obraz ni≈º sam high gain.');
                score.gain = 3;
            }

            // ===== 4. ANALIZA TGC =====
            const tgcGradient = tgcValues[7] - tgcValues[0];
            const tgcRegularGradient = tgcValues.slice(0, 5).every((v, i, arr) => i === 0 || v >= arr[i-1] - 5);
            const avgTGC = tgcValues.reduce((a, b) => a + b) / tgcValues.length;

            if (params.depth > 4 && tgcGradient < 5) {
                messages.push('üìä TGC PROBLEM: P≈Çaska krzywa na du≈ºej g≈Çƒôboko≈õci!');
                tips.push('‚ùå Dla g≈Çƒôbokich bada≈Ñ TGC MUSI rosnƒÖƒá. Attenuation jest ~ 3dB per cm.');
                tips.push('üí° Spr√≥buj: poziom 1-3 = 40-50%, poziomy 6-8 = 75-85%.');
                score.tgc = 5;
            } else if (params.depth <= 3 && tgcGradient > 30) {
                messages.push('üìä TGC: Zaostrzony profil dla ma≈Ço g≈Çƒôbokich struktur');
                tips.push('üí° Ok, ale obserwuj czy na powierzchni nie ma zbyt du≈ºego wzmocnienia.');
                score.tgc = 18;
            } else if (tgcRegularGradient) {
                messages.push('‚úÖ TGC PRAWID≈ÅOWY: Monotonicznie rosnƒÖcy profil');
                score.tgc = 28;
                if (params.gain > 65) {
                    tips.push('üí° Gain + TGC razem dzia≈ÇajƒÖ dobrze. Obserwuj aby szum siƒô nie pojawi≈Ç.');
                } else {
                    tips.push('üí° Ta konfiguracja TGC + gain powinna daƒá czysty obraz na ca≈Çej g≈Çƒôboko≈õci.');
                }
            } else {
                messages.push('‚ö†Ô∏è TGC: Nieregularna krzywa - mo≈ºe byƒá niestabilna');
                tips.push('üîß Idealnie by by≈Ço: monotoniczny wzrost, bez skok√≥w miƒôdzy poziomami.');
                score.tgc = 12;
            }

            // ===== 5. ANALIZA DEPTH =====
            if (params.depth < 2) {
                messages.push('üìè Depth BARDZO MA≈ÅY (<2cm) - —Ç–æ–ª—å–∫–æ sk√≥ra');
                tips.push('üí° Ok dla ultrasonografii sk√≥ry, ale dla typowego MSK potrzebujesz 3-5cm.');
                score.depth = 8;
            } else if (params.depth >= 2 && params.depth < 3.5) {
                messages.push('üìè Depth P≈ÅYTKI (2-3.5cm) - sk√≥ra + powiƒô≈∫ + g√≥rne miƒô≈õnie');
                if (params.frequency >= 12) {
                    messages.push('‚úÖ Dobra kombinacja dla powierzchniowych ≈õciƒôgien i nerw√≥w.');
                    score.depth = 24;
                } else {
                    tips.push('üí° Przy takiej g≈Çƒôboko≈õci mo≈ºesz podnie≈õƒá frequency powy≈ºej 12 MHz.');
                }
            } else if (params.depth >= 3.5 && params.depth <= 6) {
                messages.push('üìè Depth OPTYMALNY (3.5-6cm) - ca≈Çe miƒô≈õnie i czƒô≈õci ko≈õci');
                score.depth = 30;
                tips.push('üèÜ To jest standardowy range dla badania MSK. Wiƒôkszo≈õƒá struktur jest tu widoczna.');
                if (params.frequency >= 10 && params.frequency <= 13) {
                    tips.push('‚úÖ Frequency w tym range idealnie pasuje do tej g≈Çƒôboko≈õci.');
                }
            } else if (params.depth > 6 && params.depth <= 8) {
                messages.push('üìè Depth G≈ÅƒòBOKI (6-8cm) - struktur blisko ko≈õci miednicy');
                if (params.frequency <= 10) {
                    tips.push('‚úÖ Niska frequency jest s≈Çuszna dla takiej g≈Çƒôboko≈õci.');
                } else {
                    tips.push('‚ö†Ô∏è Frequency powinna byƒá ni≈ºsza (8-10 MHz) dla takiej g≈Çƒôboko≈õci.');
                }
                score.depth = 18;
            } else if (params.depth > 8) {
                messages.push('üìè Depth EKSTREMNIE G≈ÅƒòBOKI (>8cm) - brzeg mo≈ºliwo≈õci');
                tips.push('‚ùå Poni≈ºej 10 MHz obraz bƒôdzie bardzo s≈Çaby. Czy naprawdƒô potrzebujesz tyle g≈Çƒôboko≈õci?');
                tips.push('üí° Zwykle wystarczy 5-6cm. G≈Çƒôbiej = mniej detali.');
                score.depth = 5;
            }

            // ===== 6. ANALIZA DYNAMIC RANGE =====
            if (params.dr < 40) {
                messages.push('üìä Dynamic Range ZBYT NISKI (<40dB) - wysokokontrast ale bez szaro≈õci');
                tips.push('‚ö†Ô∏è Stratisz subtelnych detali. Ekstrahin kontrast na poziomie 40-50dB.');
                score.dr = 8;
            } else if (params.dr >= 40 && params.dr < 50) {
                messages.push('üìä Dynamic Range MOCNY (40-50dB) - wysoki kontrast');
                tips.push('üí° Dobry dla poczƒÖtkujƒÖcych - wyra≈∫ne krawƒôdzie, mniej szumem.');
                score.dr = 18;
            } else if (params.dr >= 50 && params.dr <= 70) {
                messages.push('‚úÖ Dynamic Range OPTYMALNY (50-70dB)');
                score.dr = 28;
                if (params.dr <= 60) {
                    tips.push('üí° W dolnym range (50-60): ≈Çatwiej wychwytywaƒá subtelne r√≥≈ºnice tkanki.');
                } else {
                    tips.push('üí° W g√≥rnym range (60-70): bardziej tolerancyjny na szum, ale mniej kontrastu.');
                }
            } else if (params.dr > 70 && params.dr < 80) {
                messages.push('üìä Dynamic Range szerokie (70-80dB) - bardzo subtelne detale');
                tips.push('üí° Je≈õli gain i TGC sƒÖ dobrze ustawione, zobaczysz du≈ºo szarych gradacji.');
                score.dr = 22;
            } else {
                messages.push('üìä Dynamic Range MAKSYMALNY (80dB) - wszechstronny');
                tips.push('‚ö†Ô∏è Wymaga perfekcyjnych ustawie≈Ñ gain i TGC. Inaczej obraz bƒôdzie "szary".');
                score.dr = 15;
            }

            // ===== 7. ANALIZA FRAME RATE =====
            const minFRForDepth = Math.max(20, 80 - params.depth * 10);

            if (params.fr < 25) {
                messages.push('‚è±Ô∏è Frame Rate BARDZO NISKI (<25fps) - video bƒôdzie "marszczƒÖce siƒô"');
                tips.push('‚ùå Artefakty ruchowe. Je≈õli badasz dynamikƒô (ruchy miƒô≈õni), zwiƒôksz do 40-60 fps.');
                score.fr = 5;
            } else if (params.fr >= 25 && params.fr < 40) {
                messages.push('‚è±Ô∏è Frame Rate niski (25-40fps) - ok dla statycznych struktur');
                if (params.cfBox > 0) {
                    tips.push('‚ö†Ô∏è Je≈õli korzystasz z CF Box, zwiƒôksz FR do 50+ aby uniknƒÖƒá aliasingu.');
                }
                score.fr = 15;
            } else if (params.fr >= 40 && params.fr <= 70) {
                messages.push('‚úÖ Frame Rate OPTYMALNY (40-70fps)');
                score.fr = 27;
                tips.push('üèÜ Dobry balans miƒôdzy jako≈õciƒÖ obrazu a p≈Çynno≈õciƒÖ video.');
            } else if (params.fr > 70 && params.fr <= 90) {
                messages.push('‚è±Ô∏è Frame Rate wysoki (70-90fps) - bardzo p≈Çynne video');
                tips.push('üí° ≈öwietnie do badania dynamicznego (ruchy, przep≈Çyw). Bierze na obraz: depth i gain.');
                score.fr = 22;
            } else {
                messages.push('‚è±Ô∏è Frame Rate maksymalny (>90fps) - ultra p≈Çynny');
                tips.push('‚ö†Ô∏è Mo≈ºe wymagaƒá zmniejszenia depth lub DR, aby osiƒÖgnƒÖƒá takie FR.');
                score.fr = 18;
            }

            // ===== 8. ANALIZA CF BOX =====
            if (params.cfBox === 0) {
                messages.push('üì¶ CF Box: WY≈ÅƒÑCZONY - tylko B-mode');
                tips.push('üí° OK dla statycznego badania struktur. Je≈õli badasz przep≈Çyw, w≈ÇƒÖcz CF Box.');
                score.cf = 15;
            } else if (params.cfBox === 1) {
                messages.push('üì¶ CF Box: MA≈ÅY - wƒÖski obszar Dopplera');
                if (params.focus < 2) {
                    tips.push('‚ö†Ô∏è CF Box ma≈Çy + focus p≈Çytko = mo≈ºe nie z≈Çapaƒá celu. Zwiƒôksz rozmiar.');
                } else {
                    tips.push('‚úÖ Ma≈Çy CF Box = szybkie frame rate. Dobry dla precyzyjnych bada≈Ñ naczy≈Ñ.');
                }
                score.cf = 20;
            } else if (params.cfBox === 2) {
                messages.push('üì¶ CF Box: ≈öREDNI - standard dla MSK Doppler');
                tips.push('‚úÖ Optymalny rozmiar. Obejmuje najczƒôstsze struktury przesiewowe.');
                if (params.fr < 50) {
                    tips.push('üí° Je≈õli FR spad≈Ç poni≈ºej 40fps, zmniejsz rozmiar CF Box.');
                }
                score.cf = 28;
            } else if (params.cfBox === 3) {
                messages.push('üì¶ CF Box: DU≈ªY - wiƒôkszy obszar Dopplera');
                if (params.fr > 40) {
                    tips.push('‚úÖ Du≈ºy CF Box jest ok je≈õli masz wystarczajƒÖcy FR (40+).');
                } else {
                    tips.push('‚ö†Ô∏è Du≈ºy CF Box drastycznie obni≈ºa FR. Dla tego badania (depth, gain) zmniejsz rozmiar.');
                }
                tips.push('üí° Du≈ºy CF Box dobry dla badania g≈Ç√≥wnych naczy≈Ñ (arteriae, venae).');
                score.cf = 20;
            }

            // ===== PODSUMOWANIE =====
            const totalScore = Object.values(score).reduce((a, b) => a + b, 0);
            const maxScore = 30 * 8; // 8 kategorii x max 30 pkt

            let mainMessage = messages.join('\n');
            let allTips = tips.slice(0, 4).join('\n');

            if (totalScore > 200) {
                mainMessage = 'üèÜ DOSKONA≈ÅA KONFIGURACJA!\n' + mainMessage;
            } else if (totalScore > 150) {
                mainMessage = '‚úÖ DOBRA KONFIGURACJA\n' + mainMessage;
            } else if (totalScore > 100) {
                mainMessage = '‚ö†Ô∏è ≈öREDNIA KONFIGURACJA - istniejƒÖ polepszenia\n' + mainMessage;
            } else {
                mainMessage = '‚ùå S≈ÅABA KONFIGURACJA - du≈ºe mo≈ºliwo≈õci poprawy\n' + mainMessage;
            }

            return { message: mainMessage, tip: allTips, score: totalScore, maxScore: maxScore };
        }

        // Inicjalizacja
        updateImage();
        updateAssistant();

        // Animacja
        function animate() {
            updateImage();
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
