<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSK Ultrasound Simulator - Edukacyjny</title>
    <style>
        :root {
            --color-primary: #2180a5;
            --color-primary-hover: #1a6580;
            --color-primary-active: #1a4760;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c7d;
            --color-success: #2180a5;
            --color-warning: #a84b2f;
            --color-error: #c0152f;
            --color-border: rgba(94, 82, 64, 0.2);
            --focus-ring: 0 0 0 3px rgba(33, 128, 141, 0.4);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .image-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            flex: 1;
        }

        .canvas-container {
            background: #000;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            max-height: 500px;
        }

        .image-info {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .controls-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text);
        }

        .control-group {
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--color-border);
        }

        .control-group:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .control-value {
            font-size: 12px;
            color: var(--color-primary);
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--color-secondary);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 150ms ease;
        }

        .slider::-webkit-slider-thumb:hover {
            background: var(--color-primary-hover);
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 150ms ease;
        }

        .slider::-moz-range-thumb:hover {
            background: var(--color-primary-hover);
            transform: scale(1.2);
        }

        .slider:focus-visible {
            box-shadow: var(--focus-ring);
        }

        .tgc-sliders {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 80px;
            margin-top: 8px;
            padding: 8px 4px;
            background: rgba(94, 82, 64, 0.05);
            border-radius: 4px;
        }

        .tgc-slider {
            flex: 1;
            height: 100%;
            border-radius: 2px;
            background: var(--color-secondary);
            outline: none;
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
            cursor: pointer;
        }

        .tgc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .assistant-panel {
            background: linear-gradient(135deg, rgba(33, 128, 141, 0.08) 0%, rgba(41, 150, 161, 0.08) 100%);
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            padding: 14px;
        }

        .assistant-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 12px;
            color: var(--color-primary);
        }

        .assistant-icon {
            font-size: 16px;
        }

        .assistant-message {
            font-size: 12px;
            line-height: 1.6;
            color: var(--color-text);
        }

        .message-tip {
            background: rgba(33, 128, 141, 0.1);
            padding: 8px;
            border-left: 3px solid var(--color-primary);
            border-radius: 3px;
            margin-top: 8px;
            font-size: 11px;
        }

        .stats-panel {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 14px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: var(--color-text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--color-text);
        }

        .quality-indicator {
            display: flex;
            gap: 4px;
            margin-top: 10px;
        }

        .quality-bar {
            flex: 1;
            height: 6px;
            background: var(--color-secondary);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .quality-bar.good {
            background: rgba(33, 128, 141, 0.2);
        }

        .quality-bar.warning {
            background: rgba(168, 75, 47, 0.2);
        }

        .quality-bar.bad {
            background: rgba(192, 21, 47, 0.2);
        }

        .quality-fill {
            height: 100%;
            background: var(--color-success);
            border-radius: 3px;
            transition: width 300ms ease;
        }

        .quality-bar.warning .quality-fill {
            background: var(--color-warning);
        }

        .quality-bar.bad .quality-fill {
            background: var(--color-error);
        }

        .info-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-text {
            font-size: 12px;
            line-height: 1.6;
            color: var(--color-text-secondary);
        }

        .key-relations {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            font-size: 11px;
        }

        .relation-box {
            background: rgba(94, 82, 64, 0.05);
            padding: 8px;
            border-radius: 4px;
            border-left: 2px solid var(--color-primary);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .right-column {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .key-relations {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ MSK Ultrasound Simulator</h1>
            <p class="subtitle">Interaktywny edukacyjny symulator ultrasonografii muskuloszkieletowej</p>
        </header>

        <div class="main-layout">
            <div class="left-column">
                <div class="image-section">
                    <h2 style="margin: 0 0 15px 0; font-size: 16px;">Obraz ultrasonograficzny</h2>
                    <div class="canvas-container">
                        <canvas id="ultrasoundCanvas" width="800" height="480"></canvas>
                    </div>
                    <div class="image-info" id="imageInfo">Zmie≈Ñ parametry aby zobaczyƒá zmianƒô obrazu</div>
                </div>

                <div class="info-section">
                    <div class="info-title">üìö Zasady fizyki ultrasonografii</div>
                    <div class="info-text">
                        <strong>Focal Zone (Strefa ogniskowania):</strong> Najwƒô≈∫sze miejsce wiƒÖzki ultrad≈∫wiƒôk√≥w, gdzie rozdzielczo≈õƒá jest najlepsza. Przesuniƒôcie fokusa zmienia g≈Çƒôboko≈õƒá tej strefy i ostro≈õƒá struktur w jej obrƒôbie [web:19][web:168].<br><br>
                        <strong>Frequency (Czƒôstotliwo≈õƒá):</strong> Wy≈ºsza czƒôstotliwo≈õƒá poprawia rozdzielczo≈õƒá, ale pogarsza penetracjƒô; ni≈ºsza ‚Äì odwrotnie, lepsza penetracja kosztem szczeg√≥≈Ç√≥w [web:113][web:31].<br><br>
                        <strong>Gain / TGC:</strong> Gain ustawia globalnƒÖ jasno≈õƒá obrazu, a TGC kompensuje zanik sygna≈Çu w g≈Çƒôbi. Krzywa TGC zwykle ro≈õnie ku do≈Çowi, aby utrzymaƒá zbli≈ºonƒÖ jasno≈õƒá tkanek na r√≥≈ºnych g≈Çƒôboko≈õciach [web:21][web:91].<br><br>
                        <strong>Dynamic Range:</strong> ≈örednie warto≈õci DR zapewniajƒÖ zbalansowany kontrast i widoczno≈õƒá subtelnych r√≥≈ºnic echogeniczno≈õci; skrajne DR mogƒÖ obraz ‚Äûsp≈Çaszczyƒá‚Äù lub zrobiƒá go zbyt agresywnie kontrastowym [web:19][web:31].
                    </div>
                    <div class="key-relations">
                        <div class="relation-box">
                            <strong>Focus p≈Çytko ‚Üë</strong><br>‚Üí Lepszy obraz g√≥ry<br>‚Üí Podnie≈õƒá czƒôstotliwo≈õƒá
                        </div>
                        <div class="relation-box">
                            <strong>Focus g≈Çƒôbokie ‚Üì</strong><br>‚Üí Lepszy obraz do≈Çu<br>‚Üí Obni≈ºyƒá czƒôstotliwo≈õƒá
                        </div>
                        <div class="relation-box">
                            <strong>Frame Rate ‚Üë</strong><br>‚Üí Zmniejszyƒá depth<br>‚Üí Zmniejszyƒá CF box
                        </div>
                        <div class="relation-box">
                            <strong>Resolution ‚Üë</strong><br>‚Üí Zwiƒôkszyƒá frequency<br>‚Üí Ustawiƒá focus na strukturze
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="controls-panel">
                    <div class="panel-title">‚öôÔ∏è Podstawowe kontrole</div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span>Focus Depth</span>
                            <span class="control-value" id="focusValue">3.0 cm</span>
                        </div>
                        <input type="range" id="focusSlider" class="slider" min="0.5" max="6" step="0.1" value="3">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">G≈Çƒôboko≈õƒá ogniskowania (cm)</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Gain</span>
                            <span class="control-value" id="gainValue">50%</span>
                        </div>
                        <input type="range" id="gainSlider" class="slider" min="10" max="100" step="5" value="50">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Wzmocnienie ca≈Çkowite</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Frequency</span>
                            <span class="control-value" id="freqValue">12 MHz</span>
                        </div>
                        <input type="range" id="frequencySlider" class="slider" min="5" max="18" step="1" value="12">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Czƒôstotliwo≈õƒá wiƒÖzki</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Depth</span>
                            <span class="control-value" id="depthValue">5 cm</span>
                        </div>
                        <input type="range" id="depthSlider" class="slider" min="2" max="10" step="0.5" value="5">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">G≈Çƒôboko≈õƒá penetracji</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Dynamic Range (DR)</span>
                            <span class="control-value" id="drValue">60 dB</span>
                        </div>
                        <input type="range" id="drSlider" class="slider" min="30" max="80" step="5" value="60">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Zakres dynamiki obrazu</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>Frame Rate</span>
                            <span class="control-value" id="frValue">50 fps</span>
                        </div>
                        <input type="range" id="frSlider" class="slider" min="20" max="100" step="10" value="50">
                        <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">Szybko≈õƒá od≈õwie≈ºania</div>
                    </div>

                    <div class="control-group">
                        <div class="control-label">
                            <span>CF Box (Color Flow)</span>
                            <span class="control-value" id="cfValue">Medium</span>
                        </div>
                        <select id="cfSelect" style="width: 100%; padding: 6px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 12px;">
                            <option value="0">Off</option>
                            <option value="1">Small</option>
                            <option value="2" selected>Medium</option>
                            <option value="3">Large</option>
                        </select>
                    </div>
                </div>

                <div class="controls-panel">
                    <div class="panel-title">üéöÔ∏è TGC Sliders (8 poziom√≥w)</div>
                    <div class="tgc-sliders" id="tgcContainer"></div>
                    <div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 8px; text-align: center;">Kompensacja czasu wzmocnienia</div>
                </div>

                <div class="stats-panel">
                    <div class="panel-title">üìä Jako≈õƒá obrazu</div>
                    <div class="stat-item">
                        <span class="stat-label">Rozdzielczo≈õƒá osiowa:</span>
                        <span class="stat-value" id="axialRes">0.35 mm</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Rozdzielczo≈õƒá boczna:</span>
                        <span class="stat-value" id="lateralRes">0.5 mm</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Penetracja:</span>
                        <span class="stat-value" id="penetration">≈örednia</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SNR (focal):</span>
                        <span class="stat-value" id="snr">20 dB</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CNR (warstwy):</span>
                        <span class="stat-value" id="cnr">0.0</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="font-size: 11px; margin-bottom: 5px; font-weight: 500;">Og√≥lna jako≈õƒá:</div>
                        <div class="quality-indicator">
                            <div class="quality-bar good">
                                <div class="quality-fill" id="qualityBar" style="width: 75%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="assistant-panel">
                    <div class="assistant-header">
                        <span class="assistant-icon">ü§ñ</span>
                        <span>Asystent AI</span>
                    </div>
                    <div class="assistant-message" id="assistantMessage">
                        Witaj! Jestem Twoim wirtualnym asystentem. Zmieniaj parametry a ja bƒôdƒô Ci podpowiada≈Ç jak je optymalizowaƒá.
                    </div>
                    <div class="message-tip" id="messageTip"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('ultrasoundCanvas');
        const ctx = canvas.getContext('2d');

        // Elementy kontrolne
        const focusSlider = document.getElementById('focusSlider');
        const gainSlider = document.getElementById('gainSlider');
        const frequencySlider = document.getElementById('frequencySlider');
        const depthSlider = document.getElementById('depthSlider');
        const drSlider = document.getElementById('drSlider');
        const frSlider = document.getElementById('frSlider');
        const cfSelect = document.getElementById('cfSelect');

        const displays = {
            focus: document.getElementById('focusValue'),
            gain: document.getElementById('gainValue'),
            freq: document.getElementById('freqValue'),
            depth: document.getElementById('depthValue'),
            dr: document.getElementById('drValue'),
            fr: document.getElementById('frValue'),
            cf: document.getElementById('cfValue')
        };

        let params = {
            focus: 3.0,
            gain: 50,
            frequency: 12,
            depth: 5,
            dr: 60,
            fr: 50,
            cfBox: 2
        };

        // TGC
        let tgcValues = [40, 45, 50, 55, 60, 65, 70, 75];
        const tgcContainer = document.getElementById('tgcContainer');
        tgcContainer.innerHTML = '';
        tgcValues.forEach((val, idx) => {
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.min = '0';
            slider.max = '100';
            slider.value = val;
            slider.className = 'tgc-slider';
            slider.addEventListener('input', (e) => {
                tgcValues[idx] = parseInt(e.target.value);
                updateImage();
                updateAssistant();
            });
            tgcContainer.appendChild(slider);
        });

        // Eventy
        focusSlider.addEventListener('input', (e) => {
            params.focus = parseFloat(e.target.value);
            displays.focus.textContent = params.focus.toFixed(1) + ' cm';
            updateImage();
            updateAssistant();
        });

        gainSlider.addEventListener('input', (e) => {
            params.gain = parseInt(e.target.value);
            displays.gain.textContent = params.gain + '%';
            updateImage();
            updateAssistant();
        });

        frequencySlider.addEventListener('input', (e) => {
            params.frequency = parseInt(e.target.value);
            displays.freq.textContent = params.frequency + ' MHz';
            updateImage();
            updateAssistant();
        });

        depthSlider.addEventListener('input', (e) => {
            params.depth = parseFloat(e.target.value);
            displays.depth.textContent = params.depth.toFixed(1) + ' cm';
            updateImage();
            updateAssistant();
        });

        drSlider.addEventListener('input', (e) => {
            params.dr = parseInt(e.target.value);
            displays.dr.textContent = params.dr + ' dB';
            updateImage();
            updateAssistant();
        });

        frSlider.addEventListener('input', (e) => {
            params.fr = parseInt(e.target.value);
            displays.fr.textContent = params.fr + ' fps';
            updateImage();
            updateAssistant();
        });

        cfSelect.addEventListener('change', (e) => {
            params.cfBox = parseInt(e.target.value);
            const cfLabels = ['Off', 'Small', 'Medium', 'Large'];
            displays.cf.textContent = cfLabels[params.cfBox];
            updateImage();
            updateAssistant();
        });

        // Funkcja pomocnicza do funkcji ciƒÖg≈Çej (Gauss)
        function gaussianScore(x, target, sigma, maxScore) {
            const diff = (x - target) / sigma;
            return maxScore * Math.exp(-diff * diff);
        }

        // ROI i metryki z obrazu
        function computeImageMetrics(pixelData) {
            const width = canvas.width;
            const height = canvas.height;
            const data = pixelData.data;

            function roiStats(yStart, yEnd) {
                let sum = 0;
                let sumSq = 0;
                let n = 0;
                for (let y = yStart; y < yEnd; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        const val = data[idx]; // grayscale
                        sum += val;
                        sumSq += val * val;
                        n++;
                    }
                }
                if (n === 0) return { mean: 0, std: 0 };
                const mean = sum / n;
                const variance = Math.max(0, sumSq / n - mean * mean);
                const std = Math.sqrt(variance);
                return { mean, std };
            }

            const nearEnd = Math.floor(height * 0.15);
            const farStart = Math.floor(height * 0.8);
            const near = roiStats(0, nearEnd);
            const far = roiStats(farStart, height);

            const focusY = (params.focus / params.depth) * height;
            const focusHalfWindow = Math.floor(height * 0.1);
            const focusStart = Math.max(0, Math.floor(focusY - focusHalfWindow));
            const focusEnd = Math.min(height, Math.floor(focusY + focusHalfWindow));
            const focus = roiStats(focusStart, focusEnd);

            const midStart = Math.floor(height * 0.3);
            const midEnd = Math.floor(height * 0.6);
            const mid = roiStats(midStart, midEnd);

            const snrFocus = focus.std > 1 ? focus.mean / focus.std : 0;
            const snrFar = far.std > 1 ? far.mean / far.std : 0;

            const cnr = Math.sqrt(focus.std * focus.std + mid.std * mid.std) > 0
                ? Math.abs(focus.mean - mid.mean) /
                  Math.sqrt(focus.std * focus.std + mid.std * mid.std)
                : 0;

            return {
                near,
                focus,
                far,
                mid,
                snrFocus,
                snrFar,
                cnr
            };
        }

        // Sk≈Çadowe scoringu z suwak√≥w
        function getFocusScore() {
            const target = params.depth / 2;
            return gaussianScore(params.focus, target, params.depth / 3, 10);
        }

        function getFrequencyDepthScore() {
            let target;
            if (params.depth <= 3) target = 14;
            else if (params.depth <= 5) target = 12;
            else target = 8;
            return gaussianScore(params.frequency, target, 2.0, 15);
        }

        function getGainScore() {
            const targetGain = 50;
            return gaussianScore(params.gain, targetGain, 15, 10);
        }

        function getTGCScore() {
            let smoothness = 0;
            let badDrops = 0;
            for (let i = 1; i < tgcValues.length; i++) {
                const diff = tgcValues[i] - tgcValues[i - 1];
                if (diff >= -3 && diff <= 8) smoothness++;
                if (diff < -8) badDrops++;
            }
            const base = (smoothness / 7) * 15;
            const penalty = badDrops * 3;
            return Math.max(3, base - penalty);
        }

        function getDepthScore() {
            const target = 4.5;
            return gaussianScore(params.depth, target, 2, 10);
        }

        function getDRScore() {
            const target = 60;
            return gaussianScore(params.dr, target, 10, 10);
        }

        function getFRScore() {
            const baseTarget = params.depth <= 4 ? 40 : params.depth <= 7 ? 50 : 60;
            return gaussianScore(params.fr, baseTarget, 15, 8);
        }

        function getCFScore() {
            if (params.cfBox === 0) return 7;
            if (params.cfBox === 1 || params.cfBox === 2) return 6;
            if (params.depth > 6 && params.fr < 40) return 2;
            return 4;
        }

        // Sk≈Çadowa z metryk obrazu
        function getImageMetricsScore(metrics) {
            const sFocus = metrics.snrFocus;
            const sFar = metrics.snrFar;
            const cnr = metrics.cnr;

            let score = 0;

            if (sFocus >= 5) score += 8;
            else if (sFocus >= 3) score += 5;
            else if (sFocus >= 1.5) score += 3;

            if (cnr >= 2.5) score += 7;
            else if (cnr >= 1.5) score += 5;
            else if (cnr >= 1.0) score += 3;

            if (sFar >= 3) score += 5;
            else if (sFar >= 1.5) score += 3;

            return Math.min(20, score);
        }

        function computeQualityScore(metrics) {
            const focusScore = getFocusScore();
            const freqDepthScore = getFrequencyDepthScore();
            const gainScore = getGainScore();
            const tgcScore = getTGCScore();
            const depthScore = getDepthScore();
            const drScore = getDRScore();
            const frScore = getFRScore();
            const cfScore = getCFScore();
            const imageScore = getImageMetricsScore(metrics);

            const knobTotal = focusScore + freqDepthScore + gainScore + tgcScore +
                              depthScore + drScore + frScore + cfScore;
            const knobMax = 85;
            const knobNormalized = Math.max(0, Math.min(1, knobTotal / knobMax));

            const imageMax = 20;
            const imageNormalized = Math.max(0, Math.min(1, imageScore / imageMax));

            const combined = 0.6 * knobNormalized + 0.4 * imageNormalized;
            const normalizedPercent = combined * 100;

            return {
                total: knobTotal,
                imageScore,
                normalized: normalizedPercent,
                components: {
                    focusScore,
                    freqDepthScore,
                    gainScore,
                    tgcScore,
                    depthScore,
                    drScore,
                    frScore,
                    cfScore,
                    imageScore
                }
            };
        }

        // Rysowanie obrazu
        function updateImage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a1a');
            gradient.addColorStop(1, '#0a0a0a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = pixelData.data;

            for (let i = 0; i < data.length; i += 4) {
                const pixelIndex = i / 4;
                const x = pixelIndex % canvas.width;
                const y = Math.floor(pixelIndex / canvas.width);

                const normY = y / canvas.height;
                const depthCm = normY * params.depth;

                let noise = Math.sin(x * 0.01) * Math.cos(y * 0.01) * 30 +
                            Math.random() * 40 - 20;

                let intensity = 30;

                if (depthCm < 1.0) {
                    intensity = 40 + Math.sin(x * 0.05) * 15;
                } else if (depthCm < 2.0) {
                    intensity = 50 + Math.cos(x * 0.03) * 20;
                } else if (depthCm < 4.0) {
                    intensity = 70 + Math.sin((x + y) * 0.02) * 25;
                } else {
                    intensity = 50 + Math.sin(x * 0.01) * 15;
                }

                const focusCenter = (params.focus / params.depth) * canvas.height;
                const distFromFocus = Math.abs(y - focusCenter);
                const focalWidth = 20 * (1 - Math.abs(params.frequency - 12) / 6);

                if (distFromFocus < focalWidth) {
                    const focalBoost = (1 - distFromFocus / focalWidth) * 40;
                    intensity += focalBoost;
                }

                const attenuationFactor = Math.exp(-depthCm * params.frequency / 30);
                intensity *= attenuationFactor;

                intensity = intensity * (params.gain / 50);

                const tgcIndex = Math.floor(normY * 7);
                const tgcGain = tgcValues[tgcIndex] / 50;
                intensity *= tgcGain;

                if (intensity < params.dr - 60) {
                    intensity = 0;
                }

                const freqNoise = params.frequency > 12 ? Math.random() * 20 : Math.random() * 10;
                intensity += freqNoise;
                intensity += noise * 0.1;

                intensity = Math.max(0, Math.min(255, intensity));

                data[i] = intensity;
                data[i + 1] = intensity;
                data[i + 2] = intensity;
                data[i + 3] = 255;
            }

            ctx.putImageData(pixelData, 0, 0);

            const focusY = (params.focus / params.depth) * canvas.height;
            ctx.strokeStyle = 'rgba(33, 200, 150, 0.7)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, focusY);
            ctx.lineTo(canvas.width, focusY);
            ctx.stroke();
            ctx.setLineDash([]);

            if (params.cfBox > 0) {
                drawCFBox();
            }

            drawDepthScale();

            const metrics = computeImageMetrics(pixelData);
            updateStats(metrics);
            lastMetrics = metrics;
        }

        function drawCFBox() {
            const boxSizes = [0, 0.25, 0.4, 0.6];
            const boxHeightPercent = boxSizes[params.cfBox];
            if (boxHeightPercent === 0) return;

            const focusY = (params.focus / params.depth) * canvas.height;
            const boxHeight = canvas.height * boxHeightPercent;
            const boxTop = focusY - boxHeight / 2;
            const boxWidth = canvas.width * 0.3;
            const boxLeft = (canvas.width - boxWidth) / 2;

            ctx.strokeStyle = 'rgba(50, 200, 200, 0.8)';
            ctx.lineWidth = 2;
            ctx.strokeRect(boxLeft, Math.max(0, boxTop), boxWidth, Math.min(canvas.height, boxHeight));

            ctx.fillStyle = 'rgba(50, 200, 200, 0.6)';
            ctx.font = '12px Arial';
            ctx.fillText('CF Box', boxLeft + 5, Math.max(15, boxTop + 15));
        }

        function drawDepthScale() {
            ctx.fillStyle = 'rgba(200, 200, 200, 0.7)';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';

            const step = params.depth > 5 ? 1 : 0.5;
            for (let depth = 0; depth <= params.depth; depth += step) {
                const y = (depth / params.depth) * canvas.height;
                ctx.fillText(depth.toFixed(1) + ' cm', canvas.width - 5, y + 3);
            }
        }

        function updateStats(metrics) {
            const c = 1.54;
            const pulseLength = 1 / params.frequency;
            const axialRes = (c * pulseLength * 0.5).toFixed(2);
            document.getElementById('axialRes').textContent = axialRes + ' mm';

            const focalZoneWidth = 0.3 + (12 - params.frequency) * 0.05;
            const lateralRes = (focalZoneWidth * 0.8).toFixed(2);
            document.getElementById('lateralRes').textContent = lateralRes + ' mm';

            const attenuation = Math.exp(-params.depth * params.frequency / 30);
            let penetrationText = 'S≈Çaba';
            if (attenuation > 0.5) penetrationText = '≈örednia';
            if (attenuation > 0.7) penetrationText = 'Dobra';
            document.getElementById('penetration').textContent = penetrationText;

            const snrDb = metrics.snrFocus > 0 ? 20 * Math.log10(metrics.snrFocus) : 0;
            document.getElementById('snr').textContent = snrDb.toFixed(0) + ' dB';

            document.getElementById('cnr').textContent = metrics.cnr.toFixed(2);

            const quality = computeQualityScore(metrics);
            const qualityBar = document.getElementById('qualityBar');
            qualityBar.style.width = quality.normalized.toFixed(0) + '%';

            const qualityBarDiv = qualityBar.closest('.quality-bar');
            qualityBarDiv.className = 'quality-bar';
            if (quality.normalized >= 70) {
                qualityBarDiv.classList.add('good');
            } else if (quality.normalized >= 40) {
                qualityBarDiv.classList.add('warning');
            } else {
                qualityBarDiv.classList.add('bad');
            }

            lastQuality = quality;
        }

        let lastMetrics = null;
        let lastQuality = null;

        function updateAssistant() {
            if (!lastMetrics || !lastQuality) return;
            const advice = generateAdvice(lastMetrics, lastQuality);
            document.getElementById('assistantMessage').textContent = advice.message;
            document.getElementById('messageTip').textContent = advice.tip;
        }

        function generateAdvice(metrics, quality) {
            const c = quality.components;

            let message = '';
            let tip = '';

            if (quality.normalized >= 80) {
                message = '‚úÖ Konfiguracja bardzo dobra, zar√≥wno ustawienia jak i metryki obrazu wyglƒÖdajƒÖ solidnie.';
            } else if (quality.normalized >= 60) {
                message = 'üëå Konfiguracja niez≈Ça ‚Äì obraz jest u≈ºyteczny, ale mo≈ºna go jeszcze lekko dopracowaƒá.';
            } else if (quality.normalized >= 40) {
                message = '‚ö†Ô∏è Obraz jest akceptowalny, ale kilka parametr√≥w oraz metryk obrazu jest wyra≈∫nie suboptymalnych.';
            } else {
                message = '‚ùó Ustawienia i metryki obrazu sugerujƒÖ s≈ÇabƒÖ jako≈õƒá ‚Äì spr√≥bujmy je poprawiƒá krok po kroku.';
            }

            const componentArray = [
                { name: 'focus', score: c.focusScore },
                { name: 'frequency', score: c.freqDepthScore },
                { name: 'gain', score: c.gainScore },
                { name: 'TGC', score: c.tgcScore },
                { name: 'depth', score: c.depthScore },
                { name: 'DR', score: c.drScore },
                { name: 'frame rate', score: c.frScore },
                { name: 'CF box', score: c.cfScore },
                { name: 'image metrics', score: c.imageScore }
            ];
            componentArray.sort((a, b) => a.score - b.score);
            const weakest = componentArray[0].name;

            switch (weakest) {
                case 'focus':
                    if (params.focus < params.depth / 3) {
                        tip = 'üìç Focus jest zbyt p≈Çytko wzglƒôdem ca≈Çej g≈Çƒôboko≈õci. Przesu≈Ñ go w okolice badanej struktury (czƒôsto ≈õrodek obrazu) dla lepszej ostro≈õci w ROI.';
                    } else {
                        tip = 'üìç Focus jest zbyt g≈Çƒôboko ‚Äì ogniskowanie poni≈ºej interesujƒÖcej struktury nie poprawi obrazu, a mo≈ºe pogorszyƒá near-field.';
                    }
                    break;
                case 'frequency':
                    if (params.depth <= 3 && params.frequency < 12) {
                        tip = 'üéØ Skanujesz p≈Çytko, a czƒôstotliwo≈õƒá jest niska ‚Äì podnie≈õ jƒÖ (14‚Äì18 MHz), aby poprawiƒá rozdzielczo≈õƒá w near-field.';
                    } else if (params.depth > 5 && params.frequency > 10) {
                        tip = 'üéØ Przy wiƒôkszej g≈Çƒôboko≈õci obni≈º czƒôstotliwo≈õƒá (7‚Äì9 MHz), by poprawiƒá penetracjƒô i SNR w far-field.';
                    } else {
                        tip = 'üéØ Delikatnie dopasuj czƒôstotliwo≈õƒá do g≈Çƒôboko≈õci ‚Äì im g≈Çƒôbiej, tym trochƒô ni≈ºsza czƒôstotliwo≈õƒá.';
                    }
                    break;
                case 'gain':
                    if (params.gain > 75) {
                        tip = 'üîä Gain bardzo wysoki ‚Äì obraz mo≈ºe byƒá przepalony i zaszumiony, szczeg√≥lnie w near-field. Obni≈º gain i u≈ºyj TGC, by rozja≈õniƒá tylko g≈Çƒôbsze partie.';
                    } else if (params.gain < 30) {
                        tip = 'üîä Gain bardzo niski ‚Äì obraz mo≈ºe byƒá zbyt ciemny. Podnie≈õ gain do ok. 40‚Äì60%, obserwujƒÖc czy SNR w regionie fokusa siƒô poprawia.';
                    } else {
                        tip = 'üîä Gain jest blisko akceptowalnego zakresu ‚Äì spr√≥buj ma≈Çych korekt (¬±5‚Äì10%) patrzƒÖc na stosunek sygna≈Çu do szumu w okolicy fokusa.';
                    }
                    break;
                case 'TGC':
                    tip = 'üìä Krzywa TGC jest nieregularna. Ustaw jƒÖ jako ≈Çagodnie rosnƒÖcƒÖ w d√≥≈Ç, aby SNR w far-field nie by≈Ç du≈ºo gorszy ni≈º w okolicach fokusa.';
                    break;
                case 'depth':
                    if (params.depth > 7) {
                        tip = 'üìè G≈Çƒôboko≈õƒá jest bardzo du≈ºa; rozwa≈º jej zmniejszenie tak, by najg≈Çƒôbsza interesujƒÖca struktura mia≈Ça 1‚Äì2 cm marginesu do≈Çu ekranu.';
                    } else {
                        tip = 'üìè Sprawd≈∫, czy struktura docelowa nie jest tu≈º przy dolnej krawƒôdzi; zostaw niewielki margines, ale nie przesadzaj z du≈ºƒÖ g≈Çƒôboko≈õciƒÖ.';
                    }
                    break;
                case 'DR':
                    if (params.dr > 70) {
                        tip = 'üéöÔ∏è Dynamic Range jest szeroki ‚Äì obraz mo≈ºe byƒá ma≈Ço kontrastowy. Zmniejsz DR do ok. 55‚Äì65 dB, aby poprawiƒá CNR miƒôdzy warstwami.';
                    } else {
                        tip = 'üéöÔ∏è Dynamic Range jest niski ‚Äì kontrast mocny, ale subtelne struktury mogƒÖ znikaƒá. Zwiƒôksz DR w stronƒô 50‚Äì60 dB.';
                    }
                    break;
                case 'frame rate':
                    if (params.fr < 40 && params.depth > 6) {
                        tip = '‚è±Ô∏è Frame rate niski przy du≈ºej g≈Çƒôboko≈õci ‚Äì zmniejsz depth, redukuj CF box lub zwiƒôksz FR, je≈ºeli oceniasz ruch struktur.';
                    } else {
                        tip = '‚è±Ô∏è Je≈õli oceniasz dynamiczne ruchy (≈õciƒôgna, stawy), zwiƒôksz frame rate, pamiƒôtajƒÖc o wp≈Çywie depth i CF box.';
                    }
                    break;
                case 'CF box':
                    if (params.cfBox === 3 && params.fr < 50) {
                        tip = 'üì¶ Du≈ºy CF Box mo≈ºe mocno obni≈ºaƒá frame rate i jako≈õƒá B-mode. Zmniejsz rozmiar lub wy≈ÇƒÖcz CF, je≈õli g≈Ç√≥wnie oceniasz anatomiƒô.';
                    } else {
                        tip = 'üì¶ U≈ºywaj najmniejszego CF box obejmujƒÖcego tylko interesujƒÖce naczynie, aby zachowaƒá wy≈ºszy frame rate.';
                    }
                    break;
                case 'image metrics':
                    if (metrics.snrFocus < 2) {
                        tip = 'üîç SNR w regionie fokusa jest niski ‚Äì spr√≥buj zwiƒôkszyƒá gain i/lub obni≈ºyƒá czƒôstotliwo≈õƒá (przy g≈Çƒôbszych strukturach), a tak≈ºe dopasuj TGC w tym zakresie.';
                    } else if (metrics.cnr < 1.5) {
                        tip = 'üîç CNR miƒôdzy warstwami jest niski ‚Äì dostosuj DR oraz gain/TGC tak, by r√≥≈ºnice szaro≈õci miƒôdzy powiƒôziƒÖ a miƒô≈õniem by≈Çy wyra≈∫niejsze.';
                    } else if (metrics.snrFar < 1.5 && params.depth > 5) {
                        tip = 'üîç Far-field jest mocno zaszumiony i s≈Çabo widoczny ‚Äì obni≈º czƒôstotliwo≈õƒá, podnie≈õ nieco dolne TGC i rozwa≈º minimalne zwiƒôkszenie gainu.';
                    } else {
                        tip = 'üîç Metryki obrazu sƒÖ ≈õrednie ‚Äì skup siƒô na drobnych korektach DR oraz TGC, obserwujƒÖc jak zmienia siƒô kontrast miƒôdzy warstwami.';
                    }
                    break;
            }

            if (params.focus < params.depth / 3 && params.frequency < 10) {
                tip += ' Dla tak p≈Çytkiego fokusa warto podnie≈õƒá czƒôstotliwo≈õƒá >12 MHz, co poprawi rozdzielczo≈õƒá near-field bez nadmiernego pogorszenia penetracji.';
            }
            if (params.focus > (2 * params.depth) / 3 && params.frequency > 13) {
                tip += ' Przy g≈Çƒôbokim fokusie bardzo wysoka czƒôstotliwo≈õƒá bƒôdzie silnie t≈Çumiona ‚Äì obni≈º jƒÖ, je≈õli far-field jest wyra≈∫nie ciemny i zaszumiony.';
            }

            return { message, tip };
        }

        updateImage();
        updateAssistant();

        function animate() {
            updateImage();
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
